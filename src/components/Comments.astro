---
// src/components/Comments.astro
// Giscus comments powered by GitHub Discussions
---

<div class="comments-section mt-16 pt-8 border-t border-surface-light dark:border-surface">
  <div class="max-w-3xl mx-auto">
    <h2 class="font-serif text-3xl font-bold mb-4 text-text-primary-light dark:text-text-primary">
      Comments
    </h2>
    <p class="text-text-secondary-light dark:text-text-secondary font-mono mb-8 text-sm">
      Join the discussion on GitHub. Sign in with your GitHub account to comment.
    </p>
    
    <div class="giscus-wrapper bg-surface-light dark:bg-surface rounded-xl p-6">
      <div class="giscus-container"></div>
    </div>
  </div>
</div>

<script>
  function loadGiscus() {
    const container = document.querySelector('.giscus-container');
    if (!container || container.querySelector('script')) return;

    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    script.setAttribute('data-repo', 'jolyssa/jolyssa-space');
    script.setAttribute('data-repo-id', 'R_kgDOQFcYeQ');
    script.setAttribute('data-category', 'Announcements');
    script.setAttribute('data-category-id', 'DIC_kwDOQFcYec4Cz5Iz');
    script.setAttribute('data-mapping', 'pathname');
    script.setAttribute('data-strict', '0');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-emit-metadata', '0');
    script.setAttribute('data-input-position', 'top');
    
    // Use your custom theme
    script.setAttribute('data-theme', `${window.location.origin}/giscus-custom.css`);
    
    script.setAttribute('data-lang', 'en');
    script.crossOrigin = 'anonymous';
    script.async = true;

    container.appendChild(script);
  }

  // Load Giscus when component mounts
  loadGiscus();

  // Handle theme changes
  function updateGiscusTheme() {
    const theme = document.documentElement.classList.contains('dark') 
      ? 'dark' 
      : 'light';
    
    const iframe = document.querySelector('iframe.giscus-frame');
    if (iframe?.contentWindow) {
      iframe.contentWindow.postMessage(
        { giscus: { setConfig: { theme } } },
        'https://giscus.app'
      );
    }
  }

  // Watch for theme toggle
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class') {
        setTimeout(updateGiscusTheme, 100);
      }
    });
  });

  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['class']
  });

  // Handle navigation (for view transitions if you add them later)
  document.addEventListener('astro:page-load', () => {
    loadGiscus();
  });
</script>

<style>
  .giscus-container {
    min-height: 200px;
  }

  .giscus-wrapper {
    /* Add subtle shadow to make it feel integrated */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.3s ease;
  }

  .dark .giscus-wrapper {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  .giscus-wrapper:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .dark .giscus-wrapper:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }

  /* Ensure Giscus matches your theme */
  :global(.giscus) {
    width: 100%;
  }

  :global(.giscus-frame) {
    width: 100%;
    border: none;
    min-height: 200px;
  }

  /* Additional styling to match your aesthetic */
  .comments-section {
    font-family: var(--font-mono, 'Geist Mono', monospace);
  }

  /* Make the container blend with your design */
  html:not(.dark) .giscus-container {
    color-scheme: light;
  }

  .dark .giscus-container {
    color-scheme: dark;
  }

  /* Smooth loading state */
  .giscus-container:empty::after {
    content: 'Loading comments...';
    display: block;
    text-align: center;
    padding: 3rem;
    color: var(--color-text-secondary);
    font-size: 0.875rem;
  }
</style>